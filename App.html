<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>ADIF Log Manager Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .glass-effect {
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        /* Custom range slider styles */
        .slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            background: transparent;
            cursor: pointer;
        }

        .slider-thumb::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            position: relative;
            z-index: 2;
        }

        .slider-thumb::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
        }

        .slider-thumb:hover::-webkit-slider-thumb {
            background: #2563eb;
            transform: scale(1.1);
        }
    </style>
</head>

<body class="min-h-screen gradient-bg">
    <div class="min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 fade-in">
                <h1 class="text-4xl font-bold text-white mb-2">üìª ADIF Log Manager Pro</h1>
                <p class="text-white/80">Upload, merge, filter, and analyze your amateur radio logs</p>
            </div>

            <!-- Main Container -->
            <div class="glass-effect rounded-3xl shadow-2xl p-8 space-y-8">

                <!-- File Upload Section -->
                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        üìÅ Upload ADIF Files
                        <span id="fileCount" class="ml-2 text-sm bg-blue-100 px-2 py-1 rounded-full">0 files</span>
                    </h2>
                    <div class="space-y-4">
                        <input type="file" id="adifFiles" accept=".adif,.adi" multiple
                            class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        <div id="fileList" class="space-y-2"></div>
                        <div class="flex gap-2">
                            <button onclick="mergeFiles()" id="mergeBtn" disabled
                                class="bg-green-500 hover:bg-green-600 disabled:bg-gray-300 text-white px-4 py-2 rounded-lg shadow transition-all">
                                üîó Merge All Files
                            </button>
                            <button onclick="clearFiles()"
                                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg shadow transition-all">
                                üóëÔ∏è Clear All
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Statistics Dashboard -->
                <div id="statsSection" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4">üìä Log Statistics</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="statsGrid">
                        <!-- Stats will be populated here -->
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4">üîç Advanced Filters</h2>

                    <!-- Timeline Slider -->
                    <div id="timelineSection" class="hidden mb-6">
                        <label class="block text-sm font-medium mb-3">üìÖ Timeline Selection</label>
                        <div class="bg-white rounded-lg p-4 shadow-sm">
                            <div class="flex items-center justify-between mb-2 text-xs text-gray-600">
                                <span id="timelineStart">Oldest QSO</span>
                                <span id="timelineEnd">Newest QSO</span>
                            </div>

                            <!-- Custom range slider -->
                            <div class="relative h-8 mb-3">
                                <div class="absolute inset-0 flex items-center">
                                    <div class="w-full h-2 bg-gray-200 rounded-full relative">
                                        <div id="sliderTrack" class="h-2 bg-blue-500 rounded-full absolute"></div>
                                    </div>
                                </div>
                                <input type="range" id="sliderMin"
                                    class="absolute w-full h-2 bg-transparent appearance-none pointer-events-auto slider-thumb"
                                    min="0" max="100" value="0" />
                                <input type="range" id="sliderMax"
                                    class="absolute w-full h-2 bg-transparent appearance-none pointer-events-auto slider-thumb"
                                    min="0" max="100" value="100" />
                            </div>

                            <div class="flex items-center justify-between text-sm">
                                <div class="text-center">
                                    <div class="font-medium" id="selectedStart">-</div>
                                    <div class="text-xs text-gray-500">Start</div>
                                </div>
                                <div class="flex-1 mx-4 text-center">
                                    <span id="selectedCount"
                                        class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                                        0 QSOs selected
                                    </span>
                                </div>
                                <div class="text-center">
                                    <div class="font-medium" id="selectedEnd">-</div>
                                    <div class="text-xs text-gray-500">End</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Date & Time Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Start Date:</label>
                            <input type="date" id="fromDate" class="w-full border rounded-lg px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">End Date:</label>
                            <input type="date" id="toDate" class="w-full border rounded-lg px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Start Time:</label>
                            <input type="time" id="fromTime" class="w-full border rounded-lg px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">End Time:</label>
                            <input type="time" id="toTime" class="w-full border rounded-lg px-3 py-2" />
                        </div>
                    </div>

                    <!-- Additional Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Callsign Contains:</label>
                            <input type="text" id="callFilter" placeholder="e.g. W1AW"
                                class="w-full border rounded-lg px-3 py-2" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Band:</label>
                            <select id="bandFilter" class="w-full border rounded-lg px-3 py-2">
                                <option value="">All Bands</option>
                                <option value="160m">160m</option>
                                <option value="80m">80m</option>
                                <option value="40m">40m</option>
                                <option value="20m">20m</option>
                                <option value="15m">15m</option>
                                <option value="10m">10m</option>
                                <option value="6m">6m</option>
                                <option value="2m">2m</option>
                                <option value="70cm">70cm</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Mode:</label>
                            <select id="modeFilter" class="w-full border rounded-lg px-3 py-2">
                                <option value="">All Modes</option>
                                <option value="CW">CW</option>
                                <option value="SSB">SSB</option>
                                <option value="FM">FM</option>
                                <option value="FT8">FT8</option>
                                <option value="FT4">FT4</option>
                                <option value="PSK31">PSK31</option>
                                <option value="RTTY">RTTY</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Duplicate Detection -->
                <div id="duplicateSection" class="hidden bg-gradient-to-r from-yellow-50 to-orange-50 rounded-2xl p-6">
                    <h2 class="text-xl font-semibold mb-4">‚ö†Ô∏è Duplicate QSOs Detected</h2>
                    <div id="duplicateList" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2">
                        <button onclick="removeDuplicates()"
                            class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg shadow">
                            Remove All Duplicates
                        </button>
                        <button onclick="keepDuplicates()"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg shadow">
                            Keep All QSOs
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-wrap gap-3 justify-center">
                    <button onclick="downloadFiltered()" id="downloadBtn"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        üíæ Download Filtered ADIF
                    </button>
                    <button onclick="downloadCSV()"
                        class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        üìä Download as CSV
                    </button>
                    <button onclick="generateReport()"
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg shadow-lg transition-all transform hover:scale-105">
                        üìã Generate Report
                    </button>
                </div>

                <!-- QSO Table -->
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div class="bg-gray-50 px-6 py-4 border-b">
                        <h2 class="text-lg font-semibold flex items-center justify-between">
                            üì° QSO Records
                            <span id="qsoCount" class="text-sm bg-gray-200 px-3 py-1 rounded-full">0 QSOs</span>
                        </h2>
                    </div>
                    <div class="overflow-x-auto max-h-[500px] overflow-y-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-gray-100 sticky top-0">
                                <tr>
                                    <th class="px-4 py-3 text-left font-medium">Date</th>
                                    <th class="px-4 py-3 text-left font-medium">Time</th>
                                    <th class="px-4 py-3 text-left font-medium">Callsign</th>
                                    <th class="px-4 py-3 text-left font-medium">Freq</th>
                                    <th class="px-4 py-3 text-left font-medium">Band</th>
                                    <th class="px-4 py-3 text-left font-medium">Mode</th>
                                    <th class="px-4 py-3 text-left font-medium">RST Sent</th>
                                    <th class="px-4 py-3 text-left font-medium">RST Rcvd</th>
                                    <th class="px-4 py-3 text-left font-medium">Comment</th>
                                </tr>
                            </thead>
                            <tbody id="qsoTable" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allEntries = [];
        let filteredEntries = [];
        let duplicates = [];
        let uploadedFiles = [];
        let timelineData = { minDate: '', maxDate: '', sortedEntries: [] };
        let isSliderUpdating = false;

        // Event listeners
        document.getElementById('adifFiles').addEventListener('change', handleFiles);
        document.querySelectorAll('input[type="date"], input[type="time"], input[type="text"], select').forEach(input => {
            input.addEventListener('input', updateFilteredPreview);
        });

        // Timeline slider event listeners
        document.getElementById('sliderMin').addEventListener('input', updateSliderSelection);
        document.getElementById('sliderMax').addEventListener('input', updateSliderSelection);

        function handleFiles(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (!uploadedFiles.find(f => f.name === file.name && f.size === file.size)) {
                    uploadedFiles.push(file);
                }
            });
            updateFileList();
            document.getElementById('mergeBtn').disabled = uploadedFiles.length === 0;
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileCount = document.getElementById('fileCount');

            fileCount.textContent = `${uploadedFiles.length} file${uploadedFiles.length !== 1 ? 's' : ''}`;

            fileList.innerHTML = uploadedFiles.map((file, index) => `
                <div class="flex items-center justify-between bg-white rounded-lg p-3 shadow-sm">
                    <span class="text-sm">${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                    <button onclick="removeFile(${index})" class="text-red-500 hover:text-red-700 text-sm">
                        Remove
                    </button>
                </div>
            `).join('');
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            updateFileList();
            document.getElementById('mergeBtn').disabled = uploadedFiles.length === 0;
        }

        function clearFiles() {
            uploadedFiles = [];
            allEntries = [];
            filteredEntries = [];
            duplicates = [];
            timelineData = { minDate: '', maxDate: '', sortedEntries: [] };
            document.getElementById('adifFiles').value = '';
            updateFileList();
            updateFilteredPreview();
            document.getElementById('statsSection').classList.add('hidden');
            document.getElementById('duplicateSection').classList.add('hidden');
            document.getElementById('timelineSection').classList.add('hidden');
            document.getElementById('mergeBtn').disabled = true;
        }

        async function mergeFiles() {
            allEntries = [];

            for (const file of uploadedFiles) {
                const content = await readFileAsync(file);
                const entries = parseAdif(content, file.name);
                allEntries.push(...entries);
            }

            detectDuplicates();
            setupTimeline();
            updateStats();
            updateFilteredPreview();

            document.getElementById('statsSection').classList.remove('hidden');

            if (duplicates.length > 0) {
                document.getElementById('duplicateSection').classList.remove('hidden');
                showDuplicates();
            }
        }

        function readFileAsync(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.readAsText(file);
            });
        }

        function parseAdif(content, filename) {
            const entries = [];
            const rawEntries = content.split(/<eor>/i);

            rawEntries.forEach(raw => {
                if (raw.trim().length < 10) return;

                const entry = extractFields(raw, filename);
                if (entry.date && entry.time) {
                    entries.push(entry);
                }
            });

            return entries;
        }

        function setupTimeline() {
            if (allEntries.length === 0) return;

            // Sort entries by date and time
            timelineData.sortedEntries = [...allEntries].sort((a, b) => {
                const dateA = parseInt(a.date + a.time.padEnd(4, '0'));
                const dateB = parseInt(b.date + b.time.padEnd(4, '0'));
                return dateA - dateB;
            });

            timelineData.minDate = timelineData.sortedEntries[0].date;
            timelineData.maxDate = timelineData.sortedEntries[timelineData.sortedEntries.length - 1].date;

            // Update timeline display
            document.getElementById('timelineStart').textContent = formatDate(timelineData.minDate);
            document.getElementById('timelineEnd').textContent = formatDate(timelineData.maxDate);
            document.getElementById('timelineSection').classList.remove('hidden');

            // Set slider to today's range by default (if today exists in data)
            const today = new Date();
            const todayStr = today.getFullYear().toString() +
                (today.getMonth() + 1).toString().padStart(2, '0') +
                today.getDate().toString().padStart(2, '0');

            // Find today's position in the timeline
            let todayStartIndex = -1;
            let todayEndIndex = -1;

            for (let i = 0; i < timelineData.sortedEntries.length; i++) {
                if (timelineData.sortedEntries[i].date === todayStr) {
                    if (todayStartIndex === -1) todayStartIndex = i;
                    todayEndIndex = i;
                }
            }

            if (todayStartIndex >= 0) {
                // Today exists in data - set slider to today's range
                const minPercent = (todayStartIndex / (timelineData.sortedEntries.length - 1)) * 100;
                const maxPercent = (todayEndIndex / (timelineData.sortedEntries.length - 1)) * 100;
                document.getElementById('sliderMin').value = minPercent;
                document.getElementById('sliderMax').value = maxPercent;
            } else {
                // Today doesn't exist - set to full range but keep today in date inputs
                document.getElementById('sliderMin').value = 0;
                document.getElementById('sliderMax').value = 100;
            }

            updateSliderSelection();
        }

        function updateSliderSelection() {
            if (timelineData.sortedEntries.length === 0 || isSliderUpdating) return;

            const minSlider = document.getElementById('sliderMin');
            const maxSlider = document.getElementById('sliderMax');
            const sliderTrack = document.getElementById('sliderTrack');

            let minVal = parseInt(minSlider.value);
            let maxVal = parseInt(maxSlider.value);

            // Ensure min is never greater than max
            if (minVal > maxVal) {
                if (event.target === minSlider) {
                    maxVal = minVal;
                    maxSlider.value = maxVal;
                } else {
                    minVal = maxVal;
                    minSlider.value = minVal;
                }
            }

            // Update track visual
            const minPercent = minVal;
            const maxPercent = maxVal;
            sliderTrack.style.left = minPercent + '%';
            sliderTrack.style.width = (maxPercent - minPercent) + '%';

            // Calculate actual dates based on slider positions
            const totalEntries = timelineData.sortedEntries.length;
            const minIndex = Math.floor((minVal / 100) * (totalEntries - 1));
            const maxIndex = Math.floor((maxVal / 100) * (totalEntries - 1));

            const startEntry = timelineData.sortedEntries[minIndex];
            const endEntry = timelineData.sortedEntries[maxIndex];

            // Update display
            document.getElementById('selectedStart').textContent = formatDate(startEntry.date);
            document.getElementById('selectedEnd').textContent = formatDate(endEntry.date);

            // Count QSOs in range
            const qsosInRange = timelineData.sortedEntries.slice(minIndex, maxIndex + 1).length;
            document.getElementById('selectedCount').textContent = `${qsosInRange} QSO${qsosInRange !== 1 ? 's' : ''} selected`;

            // Update date inputs to match slider selection
            isSliderUpdating = true;
            document.getElementById('fromDate').value = startEntry.date.slice(0, 4) + '-' +
                startEntry.date.slice(4, 6) + '-' +
                startEntry.date.slice(6, 8);
            document.getElementById('toDate').value = endEntry.date.slice(0, 4) + '-' +
                endEntry.date.slice(4, 6) + '-' +
                endEntry.date.slice(6, 8);
            isSliderUpdating = false;

            // Update the filtered preview
            updateFilteredPreview();
        }

        function extractFields(raw, filename) {
            return {
                raw: raw.trim() + " <EOR>",
                filename: filename,
                date: extractField(raw, 'qso_date') || '',
                time: extractField(raw, 'time_on') || '',
                call: extractField(raw, 'call') || '',
                freq: extractField(raw, 'freq') || '',
                band: extractField(raw, 'band') || getBandFromFreq(extractField(raw, 'freq')),
                mode: extractField(raw, 'mode') || '',
                rstSent: extractField(raw, 'rst_sent') || '',
                rstRcvd: extractField(raw, 'rst_rcvd') || '',
                comment: extractField(raw, 'comment') || '',
                country: extractField(raw, 'country') || '',
                gridsquare: extractField(raw, 'gridsquare') || ''
            };
        }

        function extractField(raw, fieldName) {
            const match = raw.match(new RegExp(`<${fieldName}:\\d+>([^<\\n\\r]+)`, 'i'));
            return match ? match[1].trim() : null;
        }

        function getBandFromFreq(freq) {
            if (!freq) return '';
            const f = parseFloat(freq);
            if (f >= 1.8 && f <= 2.0) return '160m';
            if (f >= 3.5 && f <= 4.0) return '80m';
            if (f >= 7.0 && f <= 7.3) return '40m';
            if (f >= 14.0 && f <= 14.35) return '20m';
            if (f >= 21.0 && f <= 21.45) return '15m';
            if (f >= 28.0 && f <= 29.7) return '10m';
            if (f >= 50.0 && f <= 54.0) return '6m';
            if (f >= 144.0 && f <= 148.0) return '2m';
            if (f >= 420.0 && f <= 450.0) return '70cm';
            return '';
        }

        function detectDuplicates() {
            duplicates = [];
            const seen = new Map();

            allEntries.forEach((entry, index) => {
                const key = `${entry.call}-${entry.date}-${entry.time}`;
                if (seen.has(key)) {
                    duplicates.push({
                        original: seen.get(key),
                        duplicate: { ...entry, index }
                    });
                } else {
                    seen.set(key, { ...entry, index });
                }
            });
        }

        function showDuplicates() {
            const duplicateList = document.getElementById('duplicateList');
            duplicateList.innerHTML = duplicates.map(dup => `
                <div class="bg-white rounded-lg p-3 shadow-sm">
                    <strong>${dup.duplicate.call}</strong> on ${formatDate(dup.duplicate.date)} at ${formatTime(dup.duplicate.time)}
                    <br><small class="text-gray-600">Files: ${dup.original.filename} & ${dup.duplicate.filename}</small>
                </div>
            `).join('');
        }

        function removeDuplicates() {
            const duplicateIndices = duplicates.map(d => d.duplicate.index).sort((a, b) => b - a);
            duplicateIndices.forEach(index => {
                allEntries.splice(index, 1);
            });
            duplicates = [];
            document.getElementById('duplicateSection').classList.add('hidden');
            updateStats();
            updateFilteredPreview();
        }

        function keepDuplicates() {
            document.getElementById('duplicateSection').classList.add('hidden');
        }

        function updateStats() {
            const stats = calculateStats();
            const statsGrid = document.getElementById('statsGrid');

            statsGrid.innerHTML = `
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-blue-600">${stats.totalQSOs}</div>
                    <div class="text-sm text-gray-600">Total QSOs</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-green-600">${stats.uniqueCallsigns}</div>
                    <div class="text-sm text-gray-600">Unique Calls</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-purple-600">${stats.topBand}</div>
                    <div class="text-sm text-gray-600">Top Band</div>
                </div>
                <div class="bg-white rounded-lg p-4 text-center shadow-sm">
                    <div class="text-2xl font-bold text-orange-600">${stats.topMode}</div>
                    <div class="text-sm text-gray-600">Top Mode</div>
                </div>
            `;
        }

        function calculateStats() {
            const callsigns = new Set();
            const bands = {};
            const modes = {};

            allEntries.forEach(entry => {
                callsigns.add(entry.call);
                bands[entry.band] = (bands[entry.band] || 0) + 1;
                modes[entry.mode] = (modes[entry.mode] || 0) + 1;
            });

            const topBand = Object.keys(bands).reduce((a, b) => bands[a] > bands[b] ? a : b, '') || 'N/A';
            const topMode = Object.keys(modes).reduce((a, b) => modes[a] > modes[b] ? a : b, '') || 'N/A';

            return {
                totalQSOs: allEntries.length,
                uniqueCallsigns: callsigns.size,
                topBand,
                topMode
            };
        }

        function updateFilteredPreview() {
            const table = document.getElementById('qsoTable');
            const qsoCount = document.getElementById('qsoCount');

            // Apply filters
            const fromDate = (document.getElementById('fromDate').value || '').replaceAll('-', '');
            const toDate = (document.getElementById('toDate').value || '99999999').replaceAll('-', '');
            const fromTime = (document.getElementById('fromTime').value || '0000').replace(':', '');
            const toTime = (document.getElementById('toTime').value || '2359').replace(':', '');
            const callFilter = document.getElementById('callFilter').value.toUpperCase();
            const bandFilter = document.getElementById('bandFilter').value;
            const modeFilter = document.getElementById('modeFilter').value;

            filteredEntries = allEntries.filter(e => {
                return (
                    e.date >= fromDate &&
                    e.date <= toDate &&
                    e.time >= fromTime &&
                    e.time <= toTime &&
                    (callFilter === '' || e.call.toUpperCase().includes(callFilter)) &&
                    (bandFilter === '' || e.band === bandFilter) &&
                    (modeFilter === '' || e.mode === modeFilter)
                );
            });

            // Sort filtered entries by date and time
            filteredEntries.sort((a, b) => {
                const dateA = parseInt(a.date + a.time.padEnd(4, '0'));
                const dateB = parseInt(b.date + b.time.padEnd(4, '0'));
                return dateA - dateB;
            });

            qsoCount.textContent = `${filteredEntries.length} QSO${filteredEntries.length !== 1 ? 's' : ''}`;

            // Update slider count if timeline is active and we're not updating from slider
            if (!isSliderUpdating && timelineData.sortedEntries.length > 0) {
                const minSlider = document.getElementById('sliderMin');
                const maxSlider = document.getElementById('sliderMax');
                const totalEntries = timelineData.sortedEntries.length;
                const minIndex = Math.floor((minSlider.value / 100) * (totalEntries - 1));
                const maxIndex = Math.floor((maxSlider.value / 100) * (totalEntries - 1));
                const qsosInRange = timelineData.sortedEntries.slice(minIndex, maxIndex + 1).length;
                document.getElementById('selectedCount').textContent = `${qsosInRange} QSO${qsosInRange !== 1 ? 's' : ''} selected`;
            }

            // Generate table with date separators
            let tableHTML = '';
            let currentDate = '';

            filteredEntries.forEach((e, index) => {
                // Add date separator if date changes
                if (e.date !== currentDate) {
                    if (currentDate !== '') {
                        // Add a subtle separator row
                        tableHTML += `
                            <tr class="bg-gray-50">
                                <td colspan="9" class="px-4 py-1">
                                    <div class="flex items-center">
                                        <div class="flex-1 border-t border-gray-300"></div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }

                    // Add date header row
                    const dayOfWeek = new Date(e.date.slice(0, 4), e.date.slice(4, 6) - 1, e.date.slice(6, 8)).toLocaleDateString('en-US', { weekday: 'long' });
                    tableHTML += `
                        <tr class="bg-blue-50 border-b-2 border-blue-200">
                            <td colspan="9" class="px-4 py-2 font-semibold text-blue-800">
                                üìÖ ${formatDate(e.date)} - ${dayOfWeek}
                            </td>
                        </tr>
                    `;
                    currentDate = e.date;
                }

                // Add QSO row
                tableHTML += `
                    <tr class="hover:bg-gray-50 ${index % 2 === 0 ? 'bg-white' : 'bg-gray-25'}">
                        <td class="px-4 py-2">${formatDate(e.date)}</td>
                        <td class="px-4 py-2 font-mono">${formatTime(e.time)}</td>
                        <td class="px-4 py-2 font-bold text-blue-700">${e.call}</td>
                        <td class="px-4 py-2 text-sm">${e.freq}</td>
                        <td class="px-4 py-2">
                            <span class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-medium">
                                ${e.band}
                            </span>
                        </td>
                        <td class="px-4 py-2">
                            <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-medium">
                                ${e.mode}
                            </span>
                        </td>
                        <td class="px-4 py-2 text-center font-mono text-sm">${e.rstSent}</td>
                        <td class="px-4 py-2 text-center font-mono text-sm">${e.rstRcvd}</td>
                        <td class="px-4 py-2 text-sm text-gray-600">${e.comment}</td>
                    </tr>
                `;
            });

            table.innerHTML = tableHTML;
        }

        function formatDate(date) {
            if (date.length !== 8) return date;
            return `${date.slice(0, 4)}-${date.slice(4, 6)}-${date.slice(6, 8)}`;
        }

        function formatTime(time) {
            if (time.length < 4) return time;
            return `${time.slice(0, 2)}:${time.slice(2, 4)}`;
        }

        function downloadFiltered() {
            if (filteredEntries.length === 0) {
                alert("No QSOs found matching the current filters.");
                return;
            }

            const adifContent = filteredEntries.map(e => e.raw).join('\n');
            downloadFile(adifContent, 'filtered_log.adi', 'text/plain');
        }

        function downloadCSV() {
            if (filteredEntries.length === 0) {
                alert("No QSOs to export.");
                return;
            }

            const headers = ['Date', 'Time', 'Callsign', 'Frequency', 'Band', 'Mode', 'RST Sent', 'RST Rcvd', 'Comment'];
            const csvContent = [
                headers.join(','),
                ...filteredEntries.map(e => [
                    formatDate(e.date),
                    formatTime(e.time),
                    e.call,
                    e.freq,
                    e.band,
                    e.mode,
                    e.rstSent,
                    e.rstRcvd,
                    `"${e.comment}"`
                ].join(','))
            ].join('\n');

            downloadFile(csvContent, 'qso_log.csv', 'text/csv');
        }

        function generateReport() {
            if (allEntries.length === 0) {
                alert("No QSOs loaded.");
                return;
            }

            const stats = calculateStats();
            const bandBreakdown = {};
            const modeBreakdown = {};

            filteredEntries.forEach(e => {
                bandBreakdown[e.band] = (bandBreakdown[e.band] || 0) + 1;
                modeBreakdown[e.mode] = (modeBreakdown[e.mode] || 0) + 1;
            });

            const reportContent = `
AMATEUR RADIO LOG REPORT
========================
Generated: ${new Date().toLocaleString()}

SUMMARY
-------
Total QSOs: ${stats.totalQSOs}
Unique Callsigns: ${stats.uniqueCallsigns}
Filtered QSOs: ${filteredEntries.length}

BAND BREAKDOWN
--------------
${Object.entries(bandBreakdown).map(([band, count]) => `${band}: ${count}`).join('\n')}

MODE BREAKDOWN
--------------
${Object.entries(modeBreakdown).map(([mode, count]) => `${mode}: ${count}`).join('\n')}

FILES PROCESSED
---------------
${uploadedFiles.map(f => f.name).join('\n')}
            `.trim();

            downloadFile(reportContent, 'qso_report.txt', 'text/plain');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }

        // Initialize with default dates
        window.onload = () => {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const isoDate = `${yyyy}-${mm}-${dd}`;

            document.getElementById('fromDate').value = isoDate;
            document.getElementById('toDate').value = isoDate;
            document.getElementById('fromTime').value = '00:00';
            document.getElementById('toTime').value = '23:59';
        };
    </script>
</body>

</html>